<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.17.0.final using JasperReports Library version 6.17.0-6d93193241dd8cc42629e188b94f9e0bc5722efd  -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="ts_c9" pageWidth="65" pageHeight="23" orientation="Landscape" columnWidth="65" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0" uuid="b2caad1d-f888-4bcc-aebf-58be02d55e29">
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="idempiere-7.1"/>
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.data.sql.SQLQueryDesigner.sash.w1" value="76"/>
	<property name="com.jaspersoft.studio.data.sql.SQLQueryDesigner.sash.w2" value="917"/>
	<parameter name="StartDate" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date(119,0,1)]]></defaultValueExpression>
	</parameter>
	<parameter name="EndDate" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date(119,7,1)]]></defaultValueExpression>
	</parameter>
	<parameter name="C_Activity_ID" class="java.lang.Integer"/>
	<parameter name="AD_Org_ID" class="java.lang.Integer"/>
	<parameter name="M_Lot_ID" class="java.lang.Integer"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String">
		<defaultValueExpression><![CDATA["dev/"]]></defaultValueExpression>
	</parameter>
	<parameter name="AD_CLIENT_ID" class="java.lang.Integer"/>
	<queryString>
		<![CDATA[select case when (sum(f.tongsx))<>0 then round((sum(f.tongmua)-sum(f.xuatkhac))/sum(f.tongsx),0)  else 0 end as kq 
from(
-- tổng mua gổ nguyên liệu 
    select  sum(k.sl) as tongmua, 0 as tongsx ,0 as xuatkhac
	FROM (
		SELECT t.lot, sum(t.sl) AS sl, sum(t.tt) AS tt
		FROM (
			SELECT att.lot, civ.qtyinvoiced AS sl, civ.priceactual * civ.qtyinvoiced AS tt
			FROM c_invoiceline civ
			JOIN c_invoice ci ON civ.c_invoice_id = ci.c_invoice_id AND ci.issotrx = 'N' AND ci.docstatus IN ('CO', 'CL')
			JOIN m_product hh ON hh.m_product_id = civ.m_product_id AND hh.m_product_category_id = 1000084 AND  hh.M_Product_ID NOT IN (1013024)
			JOIN m_attributesetinstance att ON civ.m_attributesetinstance_id = att.m_attributesetinstance_id AND att.lot IS NOT NULL
			WHERE civ.ad_client_id = $P{AD_CLIENT_ID} 
			) AS t
		JOIN m_lot lo ON lo.name = t.lot  
		where lo.ad_client_id = $P{AD_CLIENT_ID} and  lo.dateto >= $P{StartDate} AND lo.dateto <= $P{EndDate} AND (lo.M_Lot_ID = $P{M_Lot_ID} OR $P{M_Lot_ID} IS NULL)
		GROUP BY t.lot
		) AS k
	
--tổng ván sx

UNION ALL

    SELECT 0 as tongmua, sum(k.c5)  as tongsx, 0 as xuatkhac
    from ( 
	SELECT t.lot, t.sl AS c5
	FROM (
		SELECT att.m_attributesetinstance_id, att.lot, civ.productionqty AS sl
		FROM m_productionplan civ
		JOIN m_production pro ON civ.m_production_id = pro.m_production_id AND pro.docstatus IN ('CO', 'CL')
		JOIN m_product hh ON hh.m_product_id = civ.m_product_id AND hh.M_Product_Category_ID = 1000085 AND  hh.M_Product_ID NOT IN (1013026)
		JOIN m_attributesetinstance att ON civ.m_attributesetinstance_id = att.m_attributesetinstance_id  AND att.M_AttributeSet_ID = 1000065 AND att.lot IS NOT NULL
		WHERE civ.ad_client_id = $P{AD_CLIENT_ID} 
		union all
		SELECT att.m_attributesetinstance_id, att.lot,  (civ.productionqty * hh.shelfwidth * hh.shelfdepth * hh.shelfheight)/1000000000 AS sl
		FROM m_productionplan civ
		JOIN m_production pro ON civ.m_production_id = pro.m_production_id AND pro.docstatus IN ('CO', 'CL')
		JOIN m_product hh ON hh.m_product_id = civ.m_product_id AND  hh.M_Product_ID in (1017248,1017259)
		JOIN m_attributesetinstance att ON civ.m_attributesetinstance_id = att.m_attributesetinstance_id  AND att.M_AttributeSet_ID = 1000065 AND att.lot IS NOT NULL
		WHERE civ.ad_client_id = $P{AD_CLIENT_ID} 
		) AS t
	JOIN m_lot lo ON lo.name = t.lot
	where lo.ad_client_id = $P{AD_CLIENT_ID} and  lo.dateto >= $P{StartDate} AND lo.dateto <= $P{EndDate} AND (lo.M_Lot_ID=$P{M_Lot_ID} or $P{M_Lot_ID} is null)
     ) as k
	
    UNION ALL
     
       SELECT 0 as tongmua, 0  as tongsx, sum(t.sl) as xuatkhac
		FROM (
				SELECT  att.lot,civ.qtyinternaluse as sl
				FROM m_inventoryline civ				
				JOIN m_inventory ci ON civ.m_inventory_id = ci.m_inventory_id AND ci.docstatus IN ('CO', 'CL')
			    JOIN m_product hh ON civ.m_product_id = hh.m_product_id AND hh.m_product_id in (1004081,1004083,1004084,1004080)
				JOIN m_attributesetinstance att ON civ.m_attributesetinstance_id = att.m_attributesetinstance_id AND att.lot IS NOT NULL
				WHERE civ.ad_client_id = $P{AD_CLIENT_ID}  and civ.hsv_xuatkhac='Y'
		) AS t
	JOIN m_lot lo ON lo.name = t.lot
	where lo.ad_client_id = $P{AD_CLIENT_ID} and  lo.dateto >= $P{StartDate} AND lo.dateto <= $P{EndDate} AND (lo.M_Lot_ID=$P{M_Lot_ID} or $P{M_Lot_ID} is null)
	GROUP BY t.lot
		
 ) as f]]>
	</queryString>
	<field name="kq" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.label" value="kq"/>
	</field>
	<background>
		<band splitType="Stretch"/>
	</background>
	<detail>
		<band height="23" splitType="Stretch">
			<textField pattern="#,##0.###">
				<reportElement positionType="FixRelativeToBottom" x="0" y="0" width="65" height="23" uuid="6cae6d63-5203-465e-b168-756b4d718172">
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{kq}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
</jasperReport>
