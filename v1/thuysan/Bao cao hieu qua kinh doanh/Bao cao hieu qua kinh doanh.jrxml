<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.20.0.final using JasperReports Library version 6.20.0-2bc7ab61c56f459e8176eb05c7705e145cd400ad  -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="Bao cao hieu qua kinh doanh" pageWidth="842" pageHeight="595" orientation="Landscape" columnWidth="802" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="7f604dee-c3ac-4dad-a726-c9e644a62bf1">
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="psql"/>
	<property name="com.jaspersoft.studio.unit." value="pixel"/>
	<property name="net.sf.jasperreports.export.xls.exclude.origin.keep.first.band.1" value="columnHeader"/>
	<property name="net.sf.jasperreports.export.xlsx.exclude.origin.keep.first.band.1" value="columnHeader"/>
	<property name="net.sf.jasperreports.export.xls.exclude.origin.band.2" value="pageFooter"/>
	<property name="net.sf.jasperreports.export.xls.exclude.origin.band.3" value="groupHeader"/>
	<property name="net.sf.jasperreports.export.xls.remove.empty.space.between.rows" value="true"/>
	<property name="net.sf.jasperreports.export.xls.remove.empty.space.between.columns" value="true"/>
	<property name="net.sf.jasperreports.export.xls.white.page.background" value="false"/>
	<property name="net.sf.jasperreports.export.xls.detect.cell.type" value="true"/>
	<property name="net.sf.jasperreports.export.xls.ignore.graphics" value="false"/>
	<property name="net.sf.jasperreports.export.xls.exclude.origin.band.1" value="pageHeader"/>
	<property name="net.sf.jasperreports.export.xls.exclude.origin.group.3" value="ProductGroup"/>
	<property name="net.sf.jasperreports.export.xls.exclude.origin.report.3" value="ProductReport"/>
	<property name="net.sf.jasperreports.export.xls.ignore.cell.border" value="false"/>
	<property name="net.sf.jasperreports.export.xlsx.exclude.origin.band.2" value="pageFooter"/>
	<property name="net.sf.jasperreports.export.xlsx.exclude.origin.band.3" value="groupHeader"/>
	<property name="net.sf.jasperreports.export.xlsx.remove.empty.space.between.rows" value="true"/>
	<property name="net.sf.jasperreports.export.xlsx.remove.empty.space.between.columns" value="true"/>
	<property name="net.sf.jasperreports.export.xlsx.white.page.background" value="false"/>
	<property name="net.sf.jasperreports.export.xlsx.detect.cell.type" value="true"/>
	<property name="net.sf.jasperreports.export.xlsx.ignore.graphics" value="false"/>
	<property name="net.sf.jasperreports.export.xlsx.exclude.origin.band.1" value="pageHeader"/>
	<property name="net.sf.jasperreports.export.xlsx.exclude.origin.group.3" value="ProductGroup"/>
	<property name="net.sf.jasperreports.export.xlsx.exclude.origin.report.3" value="ProductReport"/>
	<property name="net.sf.jasperreports.export.xlsx.ignore.cell.border" value="false"/>
	<property name="com.jaspersoft.studio.unit.pageHeight" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.pageWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.topMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.bottomMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.leftMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.rightMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnSpacing" value="pixel"/>
	<parameter name="AD_CLIENT_ID" class="java.lang.Integer"/>
	<parameter name="StartDate" class="java.util.Date"/>
	<parameter name="EndDate" class="java.util.Date"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String">
		<defaultValueExpression><![CDATA["dev/"]]></defaultValueExpression>
	</parameter>
	<queryString language="SQL">
		<![CDATA[-- Bước 1: Xác định các đơn hàng (orders) liên quan trong khoảng thời gian báo cáo.
WITH _1_relevant_orders AS (
    SELECT DISTINCT ci.c_order_id
    FROM c_invoice ci
    WHERE ci.ad_client_id = $P{AD_CLIENT_ID}
      AND ci.dateacct BETWEEN $P{StartDate} AND $P{EndDate}
      AND ci.issotrx = 'Y'
      AND ci.docstatus IN ('CL', 'CO')
      AND right(ci.documentno, 1) <> 'N'
),
-- Các CTE tính toán giờ đây sẽ JOIN với relevant_orders để chỉ xử lý trên dữ liệu cần thiết
_1_tong_chi_phi AS (
    SELECT
        civ2.c_order_id,
        SUM(CASE WHEN cd.docbasetype = 'APC' THEN -1 * civ2.linenetamt ELSE civ2.linenetamt END) AS tien
    FROM c_invoiceline civ2
    JOIN c_invoice ci2 ON ci2.c_invoice_id = civ2.c_invoice_id
    JOIN c_charge cc ON cc.c_charge_id = civ2.c_charge_id AND cc.hsv_vanchuyen = 'Y'
    JOIN c_doctype cd ON cd.c_doctype_id = ci2.c_doctype_id
    -- Tối ưu: Chỉ tính toán trên các order liên quan
    JOIN _1_relevant_orders ro ON ro.c_order_id = civ2.c_order_id
    WHERE ci2.issotrx = 'N'
      AND ci2.docstatus IN ('CL', 'CO')
      AND ci2.ad_client_id = $P{AD_CLIENT_ID}
    GROUP BY civ2.c_order_id
),

--select * from tong_chi_phi 
_1_tong_sl AS (
    SELECT
        ci2.c_order_id,
        SUM(civ2.qtyinvoiced) AS sl_tong
    FROM c_invoice ci2
    JOIN c_invoiceline civ2 ON ci2.c_invoice_id = civ2.c_invoice_id
    JOIN m_product hh2 ON hh2.m_product_id = civ2.m_product_id AND hh2.m_attributeset_id in (1000000,1000199)
    -- Tối ưu: Chỉ tính toán trên các order liên quan
    WHERE ci2.c_order_id IN (SELECT c_order_id FROM _1_relevant_orders) -- Dùng IN hoặc JOIN đều được
      AND ci2.issotrx = 'Y'
      AND ci2.docstatus IN ('CL', 'CO')
      AND ci2.ad_client_id = $P{AD_CLIENT_ID}
      AND ci2.dateacct BETWEEN $P{StartDate} AND $P{EndDate} -- Giữ lại để tận dụng index
    GROUP BY ci2.c_order_id
),
-- Các CTE tra cứu định mức không cần thay đổi nhiều vì đã lọc theo ngày
dm_nl AS (
    SELECT
        dgl.m_product_id,
        dgl.hsv_dinhmuc,
        dg.startdate,
        dg.enddate
    FROM hsv_dongia dg
    JOIN hsv_nkdongialine dgl ON dg.hsv_dongia_id = dgl.hsv_dongia_id
    WHERE dg.ad_client_id = $P{AD_CLIENT_ID}
      AND dg.hsv_loaidongia_id in (1000055,1000073)
      AND dg.enddate >= $P{StartDate}
      AND dg.startdate <= $P{EndDate}
),
dm_cuoc_bien AS (
    SELECT
        dgl.hsv_dinhmuc1 AS vc,
        dgl.hsv_cangbien_id,
        dg.startdate,
        dg.enddate
    FROM hsv_dongia dg
    JOIN hsv_nkdongialine dgl ON dg.hsv_dongia_id = dgl.hsv_dongia_id
    WHERE dg.ad_client_id = $P{AD_CLIENT_ID}
      AND dg.hsv_loaidongia_id in (1000056,1000074)
      AND dg.enddate >= $P{StartDate}
      AND dg.startdate <= $P{EndDate}
),
cp_dm_sx AS (
    SELECT
        dgl.m_attributevalue_id,
        dgl.amountdg1 AS cpdm,
        dg.startdate,
        dg.enddate
    FROM hsv_dongia dg
    JOIN hsv_nkdongialine dgl ON dg.hsv_dongia_id = dgl.hsv_dongia_id
    WHERE dg.ad_client_id = $P{AD_CLIENT_ID}
      AND dg.hsv_loaidongia_id in (1000054,1000072)
      AND dg.enddate >= $P{StartDate}
      AND dg.startdate <= $P{EndDate}
),
_3_dongia AS (
    SELECT
        dgl.m_product_id,
        dgl.hsv_dinhmuc,
        dg.startdate,
        dg.enddate
    FROM hsv_dongia dg
    JOIN hsv_nkdongialine dgl ON dgl.hsv_dongia_id = dg.hsv_dongia_id
    WHERE dg.hsv_loaidongia_id in (1000058,1000076) -- Lọc theo loại định mức
      AND dg.ad_client_id = $P{AD_CLIENT_ID}
),
dongia AS (
    SELECT DISTINCT ON (dgl.hsv_luongnasa_id)
        dg.startdate, dg.enddate, nasa."name", nasa.value,
        dgl.hsv_dinhmuc AS dgb, dgl.amountdg2 AS dgb1, dgl.amountdg1 AS dgb5,
        dgl.hsv_dinhmuc1 AS dgnt, dgl.hsv_dinhmuc2 AS dgnm
    FROM hsv_dongia dg
    JOIN hsv_nkdongialine dgl ON dg.hsv_dongia_id = dgl.hsv_dongia_id
    JOIN hsv_luongnasa nasa ON nasa.hsv_luongnasa_id = dgl.hsv_luongnasa_id
    WHERE
        dg.hsv_loaidongia_id in (1000057,1000075)
        AND dg.ad_client_id = $P{AD_CLIENT_ID}
        AND $P{EndDate}::date BETWEEN $P{StartDate} AND $P{EndDate}
    ORDER BY dgl.hsv_luongnasa_id, dg.startdate DESC
),
base_data AS (
    SELECT
        io.movementqty,
        hh.M_AttributeSet_ID,
        tt.hsv_c_thuoctinh_id
    FROM m_inoutline io
    JOIN m_inout iol ON io.m_inout_id = iol.m_inout_id
        AND iol.docstatus IN ('CO', 'CL')
        AND iol.issotrx = 'Y'
        AND iol.movementdate BETWEEN $P{StartDate} AND $P{EndDate}
        AND iol.AD_org_id in (1000027,1000160)
    JOIN m_product hh ON io.m_product_id = hh.m_product_id
        AND hh.M_AttributeSet_ID IN (1000000, 1000062, 1000018,1000199,1000200,1000202)
    LEFT JOIN (
        SELECT tt.m_attributesetinstance_id, gtt.hsv_c_thuoctinh_id
        FROM m_attributeinstance tt
        JOIN m_attributevalue gtt ON tt.m_attributevalue_id = gtt.m_attributevalue_id
            AND gtt.m_attribute_id in (1000001,1000146)
            AND gtt.hsv_c_thuoctinh_id IN (1000013, 1000005, 1000006, 1000007, 1000019,1000145,1000137,1000138,1000139,1000146)
        WHERE tt.ad_client_id = $P{AD_CLIENT_ID}
    ) tt ON io.m_attributesetinstance_id = tt.m_attributesetinstance_id
    WHERE io.ad_client_id = $P{AD_CLIENT_ID}
),
_3_base_production AS (
    SELECT
        ci.m_production_id,
        ci.movementdate,
        civ.m_product_id,
        civ.productionqty,
        civ.m_attributesetinstance_id,
        hh.m_attributeset_id,
        hh.value,
        k.hsv_dinhmuc
    FROM m_production ci
    JOIN m_productionplan civ ON ci.m_production_id = civ.m_production_id
    JOIN m_product hh ON hh.m_product_id = civ.m_product_id
    JOIN _3_dongia k ON k.m_product_id = civ.m_product_id
    WHERE ci.ad_client_id = $P{AD_CLIENT_ID}
      -- Lọc ngày tháng tập trung
      AND ci.movementdate BETWEEN $P{StartDate} AND $P{EndDate}
      AND ci.movementdate BETWEEN k.startdate AND k.enddate
      AND ci.c_campaign_id IN (1000018, 1000093,1000100,1000104)
      AND ci.docstatus IN ('CL', 'CO')
),
_3_classified_production AS (
    SELECT
        bp.*,
        -- Sử dụng subquery để lấy tất cả m_attributevalue_id vào một mảng
        (
            SELECT array_agg(att.m_attributevalue_id)
            FROM m_attributeinstance att
            WHERE att.m_attributesetinstance_id = bp.m_attributesetinstance_id
        ) AS attribute_values
    FROM _3_base_production bp
),
sl_xuatban AS (
    SELECT
        COALESCE(SUM(CASE WHEN bd.M_AttributeSet_ID in (1000000,1000199) AND bd.hsv_c_thuoctinh_id in (1000013,1000145) THEN bd.movementqty ELSE 0 END), 0) AS slb,
        COALESCE(SUM(CASE WHEN bd.M_AttributeSet_ID in (1000000,1000199) AND bd.hsv_c_thuoctinh_id in (1000005,1000137) THEN bd.movementqty ELSE 0 END), 0) AS slb1,
        COALESCE(SUM(CASE WHEN bd.M_AttributeSet_ID in (1000000,1000199) AND bd.hsv_c_thuoctinh_id IN (1000006, 1000007, 1000019,1000138,1000139,1000146) THEN bd.movementqty ELSE 0 END), 0) AS slb5,
        COALESCE(SUM(CASE WHEN bd.M_AttributeSet_ID in (1000062,1000200) THEN bd.movementqty ELSE 0 END), 0) AS slnt,
        COALESCE(SUM(CASE WHEN bd.M_AttributeSet_ID in (1000018,1000202) THEN bd.movementqty ELSE 0 END), 0) AS slnm
    FROM base_data bd
),
fact_acct_common AS (
    -- Truy vấn con chung để lấy tất cả dữ liệu từ Fact_Acct một lần
    SELECT
        fa.amtacctdr,
        fa.amtacctcr,
        fa.account_id,
        fa.dateacct,
        fa.ad_table_id,
        fa.c_bpartner_id,
        fa.c_activity_id,
        fa.record_id,
        fa.line_id,
        fa.m_product_id,
        gl.IsGenerated,
        m.C_DocType_ID,
        hh.M_PartType_ID
    FROM Fact_Acct fa
    LEFT JOIN gl_journalline gl ON fa.record_id = gl.gl_journal_id
        AND fa.line_id = gl.gl_journalline_id
        AND fa.Account_ID = gl.Account_ID
    LEFT JOIN gl_journal a ON a.gl_journal_id = fa.record_id
        AND a.docstatus IN ('CO', 'CL')
    LEFT JOIN M_Inventory m ON fa.record_id = m.M_Inventory_id
        AND m.docstatus IN ('CO', 'CL')
        AND fa.ad_table_id = 321
    LEFT JOIN m_product hh ON fa.m_product_id = hh.m_product_id
    WHERE
        fa.AD_Client_ID = $P{AD_CLIENT_ID}
        AND fa.AD_org_id in (1000027,1000160)
        AND fa.dateacct BETWEEN $P{StartDate} and $P{EndDate}
),
all_costs AS (
    SELECT
        -- '01'
        SUM(CASE
            WHEN tk.value LIKE '6276%' AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.c_activity_id NOT IN (1000108, 1000217,1000344,1000343) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_01_period,

        -- '02'

        SUM(CASE
            WHEN tk.value LIKE '6275%' AND t.ad_table_id = 318 AND t.C_BPartner_ID IN (1000147, 1000741) AND t.c_activity_id NOT IN (1000108, 1000217,1000344,1000343) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_02_period,

        -- '03'
        SUM(CASE
            WHEN tk.value LIKE '6275%' AND t.ad_table_id = 318 AND t.C_BPartner_ID in (1000247,1021279) AND t.c_activity_id NOT IN (1000108, 1000217,1000344,1000343) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_03_period,

        -- '04'
 	SUM(t.amtacctdr - t.amtacctcr) 
	FILTER (
    	WHERE t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
    	AND (	            
          		( 
         			t.ad_table_id <> 224 
		             OR (t.ad_table_id = 224 AND t.IsGenerated = 'N')
		             OR (t.ad_table_id = 224 AND t.line_id IS NULL)                     
        		) and not (t.ad_table_id = 318 AND t.C_BPartner_ID IN (1000147, 1000741, 1000247))
      		)
     	AND LEFT(tk.value,4) IN ('6275')
      	AND t.c_activity_id NOT IN (1000108, 1000217,1000344,1000343)
) 		AS cp_04_period,

        -- '05'
        SUM(CASE
            WHEN tk.value LIKE '6278%' AND t.ad_table_id = 321 AND t.C_DocType_ID IN (1000167, 1000164,1001350,1001347) AND t.M_PartType_ID in (1000076,1000163) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_05_period,

        -- Tương tự cho '06', '07', '08', '09', '10'
        SUM(CASE WHEN tk.value LIKE '6278%' AND t.ad_table_id = 321 AND t.C_DocType_ID IN (1000167, 1000164,1001350,1001347) AND t.M_PartType_ID in (1000077,1000164) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate} THEN t.amtacctdr - t.amtacctcr ELSE 0 END) AS cp_06_period,
        SUM(CASE WHEN tk.value LIKE '6278%' AND t.ad_table_id = 321 AND t.C_DocType_ID IN (1000167, 1000164,1001350,1001347) AND t.M_PartType_ID in (1000078,1000165) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate} THEN t.amtacctdr - t.amtacctcr ELSE 0 END) AS cp_07_period,
        SUM(CASE WHEN tk.value LIKE '6278%' AND t.ad_table_id = 321 AND t.C_DocType_ID IN (1000167, 1000164,1001350,1001347) AND t.M_PartType_ID in (1000079,1000166) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate} THEN t.amtacctdr - t.amtacctcr ELSE 0 END) AS cp_08_period,
        
       
    	SUM(t.amtacctdr - t.amtacctcr) 
             FILTER (WHERE t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
                     AND t.ad_table_id = 321
                     AND t.C_DocType_ID IN (1000167,1000164,1001350,1001347)
                     AND t.M_PartType_ID in (1000080,1000167)
                     AND LEFT(tk.value,4) IN ('6278','6272')) AS cp_09_period,
 	 	SUM(t.amtacctdr - t.amtacctcr) 
             FILTER (WHERE t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
                     AND t.ad_table_id = 321
                     AND t.C_DocType_ID IN (1000167,1000164,1001350,1001347)
                     AND t.M_PartType_ID in (1000081,1000168)
                     AND LEFT(tk.value,4) IN ('6278','6272')) AS cp_10_period,

        -- '11'
        
	 SUM(t.amtacctdr - t.amtacctcr) 
		FILTER (
    	WHERE t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
    	AND (	            
          		( 
         			t.ad_table_id <> 224 
		             OR (t.ad_table_id = 224 AND t.IsGenerated = 'N')
		             OR (t.ad_table_id = 224 AND t.line_id IS NULL)                     
        		) and not (t.ad_table_id = 321 AND t.M_PartType_ID IN (1000076,1000077,1000078,1000079,1000163,1000164,1000165,1000166))
      		)
     	AND LEFT(tk.value,4) IN ('6278', '6272')
      	AND t.c_activity_id NOT IN (1000108, 1000217,1000344,1000343)
) AS cp_11_period,

        -- '12'
        SUM(CASE
            WHEN tk.value LIKE '6277%' AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_12_period,

        -- '13'
        
        SUM(CASE
            WHEN tk.value LIKE '6412%' AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_13_period,

        -- '14'
        
        SUM(CASE
            WHEN tk.value LIKE '6352%' AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_14_period,

        -- '15'
        
        SUM(CASE
            WHEN tk.value IN ('6273', '6274') AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_15_period,

        -- '16'
        
        SUM(CASE
            WHEN tk.value LIKE '6221%' AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_16_period,

        -- '17'
       
  		
 		coalesce(SUM(t.amtacctdr - t.amtacctcr) 
		FILTER (
    		WHERE t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
    		AND (	            
          			( 
         				t.ad_table_id <> 224 
		             	OR (t.ad_table_id = 224 AND t.IsGenerated = 'N')
		             	OR (t.ad_table_id = 224 AND t.line_id IS NULL)                     
        			) 
      			)
     		AND LEFT(tk.value,4) IN ('6421', '6411', '6271')
      	
		),0) AS cp_17_period,


        -- '18'
        
        SUM(CASE
            WHEN tk.value IN ('6423', '6424') AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_18_period,

        -- '19'
        
        SUM(CASE
            WHEN tk.value LIKE '6418%' AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_19_period,

        -- '20'
        
        SUM(CASE
            WHEN tk.value IN ('6422', '6426') AND (t.ad_table_id <> 224 OR (t.ad_table_id = 224 AND t.IsGenerated = 'N') OR (t.ad_table_id = 224 AND t.line_id IS NULL)) AND t.dateacct BETWEEN $P{StartDate} and $P{EndDate}
            THEN t.amtacctdr - t.amtacctcr ELSE 0 END
        ) AS cp_20_period
    FROM fact_acct_common t
    JOIN c_elementvalue tk ON t.account_id = tk.c_elementvalue_id AND tk.AD_Client_ID = $P{AD_CLIENT_ID}
    
),

so_luong_ban as
(
	SELECT 
		COALESCE(sum(slb),0) +
		COALESCE(sum(slb1),0) +
		COALESCE(sum(slb5),0) +
		coalesce(sum(slnt),0) +
		coalesce(sum(slnm),0) as sl
		
	from(
		
		select 
			(CASE WHEN ta.hsv_c_thuoctinh_id in (1000013,1000145) THEN io.movementqty ELSE 0 end) AS slb,
		    (CASE WHEN ta.hsv_c_thuoctinh_id in (1000005,1000137) THEN io.movementqty ELSE 0 END) AS slb1,
		    (CASE WHEN ta.hsv_c_thuoctinh_id IN (1000006, 1000007, 1000019,1000138,1000139,1000146) THEN io.movementqty ELSE 0 END) AS slb5,
			0 as slnt,
			0 as slnm
	   
		FROM m_inoutline io
		JOIN  m_inout iol ON io.m_inout_id = iol.m_inout_id  AND iol.docstatus IN ('CO', 'CL')   AND iol.issotrx = 'Y'  AND iol.AD_org_id in (1000027,1000160)
		JOIN m_product hh ON io.m_product_id = hh.m_product_id  AND hh.M_AttributeSet_ID in (1000000,1000199)
		JOIN (
			SELECT tt.m_attributesetinstance_id,  gtt.hsv_c_thuoctinh_id
		    FROM  m_attributeinstance tt
		    JOIN m_attributevalue gtt ON tt.m_attributevalue_id = gtt.m_attributevalue_id 
		    WHERE tt.ad_client_id = $P{AD_CLIENT_ID}
		) ta ON io.m_attributesetinstance_id = ta.m_attributesetinstance_id
		WHERE io.ad_client_id = $P{AD_CLIENT_ID} and iol.movementdate >= $P{StartDate} AND iol.movementdate <= $P{EndDate}
		
		union all 
		
		select 	0 AS slb,
		   	 	0 AS slb1,
		    	0 AS slb5,
				case when hh.M_AttributeSet_ID in (1000062,1000200) then io.movementqty  else 0 end as slnt, 
				case when hh.M_AttributeSet_ID in (1000018,1000202) then io.movementqty else 0 end as slnm 
		FROM m_inoutline io
		JOIN  m_inout iol ON io.m_inout_id = iol.m_inout_id  AND iol.docstatus IN ('CO', 'CL')   AND iol.issotrx = 'Y' AND iol.AD_org_id in (1000027,1000160)
		JOIN m_product hh ON io.m_product_id = hh.m_product_id  
		and io.ad_client_id =$P{AD_CLIENT_ID} and iol.dateacct  >= $P{StartDate} AND iol.dateacct  <= $P{EndDate}
) as k
),
_3_1_sl_sx as (
	 select sum(nll.qty)  AS sl,
	    SUM(nll.amount) AS tt
	 from hsv_nlsx nl
	 join hsv_nlsxline nll on nl.hsv_nlsx_id = nll.hsv_nlsx_id 
	 where nl.ad_client_id = $P{AD_CLIENT_ID}
	 and nll.dateacct between $P{StartDate} and $P{EndDate}
)

select 1 as stt, 'Lãi gộp đơn hàng  so với định mức CP' as noidung,
	sum(civ.qtyinvoiced) AS sl,
    sum(case when ci.c_currency_id <> 234 then civ.linenetamt * tygia.multiplyrate  else civ.linenetamt end) AS tt,
     sum(civ.qtyinvoiced * COALESCE(dm_nl.hsv_dinhmuc, 0))
     + sum(COALESCE(civ.qtyinvoiced * tong_chi_phi.tien / NULLIF(tong_sl.sl_tong , 0), 0))
     + sum(CASE WHEN tong_chi_phi.tien IS NULL THEN  COALESCE(civ.qtyinvoiced * tygia.multiplyrate *dm_cuoc_bien.vc / 24000, NULL)  end) 
     + sum(civ.qtyinvoiced * COALESCE(cp_dm_sx.cpdm, 0)) as tt_dm,
    sum(case when ci.c_currency_id <> 234 then civ.linenetamt * tygia.multiplyrate  else civ.linenetamt end)
    - sum(civ.qtyinvoiced * COALESCE(dm_nl.hsv_dinhmuc, 0))
    - sum(COALESCE(civ.qtyinvoiced * tong_chi_phi.tien / NULLIF(tong_sl.sl_tong , 0), 0)) 
    - sum(CASE WHEN tong_chi_phi.tien IS NULL THEN  COALESCE(civ.qtyinvoiced * tygia.multiplyrate *dm_cuoc_bien.vc / 24000, NULL)  end)
    - sum(civ.qtyinvoiced * COALESCE(cp_dm_sx.cpdm, 0)) AS cl,
   case when sum(civ.qtyinvoiced) <> 0 then (sum(case when ci.c_currency_id <> 234 then civ.linenetamt * tygia.multiplyrate  else civ.linenetamt end)
    - sum(civ.qtyinvoiced * COALESCE(dm_nl.hsv_dinhmuc, 0))
    - sum(COALESCE(civ.qtyinvoiced * tong_chi_phi.tien / NULLIF(tong_sl.sl_tong, 0), 0)) 
    - sum(CASE WHEN tong_chi_phi.tien IS NULL THEN  COALESCE(civ.qtyinvoiced * tygia.multiplyrate *dm_cuoc_bien.vc / 24000, NULL)  end )
    - sum(civ.qtyinvoiced * COALESCE(cp_dm_sx.cpdm, 0))
    )/sum(civ.qtyinvoiced) end as hq

FROM c_invoice ci
JOIN c_invoiceline civ ON ci.c_invoice_id = civ.c_invoice_id
JOIN m_product hh ON hh.m_product_id = civ.m_product_id AND hh.m_attributeset_id in (1000000,1000199)
JOIN m_attributeinstance ma ON ma.m_attributesetinstance_id = civ.m_attributesetinstance_id AND ma.m_attribute_id in (1000001,1000146)
LEFT JOIN c_order co ON co.c_order_id = ci.c_order_id
LEFT JOIN LATERAL (
    SELECT cr.multiplyrate
    FROM c_conversion_rate cr
    WHERE cr.c_currency_id = ci.c_currency_id
      AND ci.dateacct BETWEEN cr.validfrom AND COALESCE(cr.validto, ci.dateacct)
      AND cr.c_conversiontype_id = ci.c_conversiontype_id
      AND cr.ad_client_id = ci.ad_client_id
    ORDER BY cr.validfrom DESC
    LIMIT 1
) tygia ON true
LEFT JOIN dm_nl ON dm_nl.m_product_id = hh.m_product_id
    AND ci.dateacct BETWEEN dm_nl.startdate AND dm_nl.enddate
LEFT JOIN _1_tong_chi_phi tong_chi_phi  ON tong_chi_phi.c_order_id = co.c_order_id
LEFT JOIN _1_tong_sl  tong_sl ON tong_sl.c_order_id = co.c_order_id
LEFT JOIN cp_dm_sx ON cp_dm_sx.m_attributevalue_id = ma.m_attributevalue_id
    AND ci.dateacct BETWEEN cp_dm_sx.startdate AND cp_dm_sx.enddate
LEFT JOIN dm_cuoc_bien ON dm_cuoc_bien.hsv_cangbien_id = co.hsv_cangbien_id
    AND ci.dateacct BETWEEN dm_cuoc_bien.startdate AND dm_cuoc_bien.enddate
WHERE ci.ad_client_id = $P{AD_CLIENT_ID}
  AND ci.dateacct BETWEEN $P{StartDate} AND $P{EndDate}
  AND ci.issotrx = 'Y'
  AND ci.docstatus IN ('CL', 'CO')
  AND right(ci.documentno, 1) <> 'N'
  AND civ.qtyinvoiced <> 0

union all

select 2 as stt, 'HQ chi phí sx so đinh mức' as noidung,
	sl_b.sl as sl,
    sum(k.cp) as tt,
    sum(dg.dgb * xb.slb + xb.slb1 * dg.dgb1 + dg.dgb5 * xb.slb5 + dg.dgnt * xb.slnt + dg.dgnm * xb.slnm) AS tt_dm,
   (sum(dg.dgb * xb.slb + xb.slb1 * dg.dgb1 + dg.dgb5 * xb.slb5 + dg.dgnt * xb.slnt + dg.dgnm * xb.slnm))-sum(k.cp)  as cl, 
    case when sl_b.sl <>0 then  ((sum(dg.dgb * xb.slb + xb.slb1 * dg.dgb1 + dg.dgb5 * xb.slb5 + dg.dgnt * xb.slnt + dg.dgnm * xb.slnm)-sum(k.cp)))/sl_b.sl end as hq
    
    
FROM (
    		  SELECT '01' AS id, cp_01_period AS cp  FROM all_costs
    UNION ALL SELECT '02', cp_02_period FROM all_costs
    UNION ALL SELECT '03', cp_03_period FROM all_costs
    UNION ALL SELECT '04', cp_04_period FROM all_costs
    UNION ALL SELECT '05', cp_05_period FROM all_costs
    UNION ALL SELECT '06', cp_06_period FROM all_costs
    UNION ALL SELECT '07', cp_07_period FROM all_costs
    UNION ALL SELECT '08', cp_08_period FROM all_costs
    UNION ALL SELECT '09', cp_09_period FROM all_costs
    UNION ALL SELECT '10', cp_10_period FROM all_costs
    UNION ALL SELECT '11', cp_11_period FROM all_costs
    UNION ALL SELECT '12', cp_12_period FROM all_costs
    UNION ALL SELECT '13', cp_13_period FROM all_costs
    UNION ALL SELECT '14', cp_14_period FROM all_costs
    UNION ALL SELECT '15', cp_15_period FROM all_costs
    UNION ALL SELECT '16', cp_16_period FROM all_costs
    UNION ALL SELECT '17', cp_17_period FROM all_costs
    UNION ALL SELECT '18', cp_18_period FROM all_costs
    UNION ALL SELECT '19', cp_19_period FROM all_costs
    UNION ALL SELECT '20', cp_20_period FROM all_costs
) AS k
LEFT JOIN sl_xuatban xb ON TRUE
LEFT JOIN dongia dg ON dg.value = k.id
left join so_luong_ban sl_b on true
group by sl_b.sl

union all


-- Bước 4: Tổng hợp dữ liệu bằng CASE WHEN (thay thế 8 khối UNION ALL đầu tiên) và UNION với khối 9
select 3 as stt, 'Hiệu quả chi phí N liệu so đ mức' as nodung, 
    sl_sx.sl as sl_nl,
    sl_sx.tt as tt_nl,
    SUM(k.tt) AS tt_tp,
    SUM(k.tt) - sl_sx.tt AS cl,
    case when SUM(k.sl) <> 0 then (SUM(k.tt) - sl_sx.tt)/SUM(k.sl) else 0 end  as hq
    
   
FROM (
    -- Gộp 8 Nhóm đầu tiên thành một khối SELECT
    SELECT
        -- Xác định ID nhóm
        
        case when cp.m_attributeset_id IN (1000012, 1000062,1000202,1000203) or cp.m_attributeset_id IN (1000018, 1000031,1000202,1000201) then null else cp.productionqty end AS sl,
        cp.productionqty * cp.hsv_dinhmuc AS tt
    FROM _3_classified_production cp
    WHERE (
        cp.m_attributeset_id in (1000000,1000199) OR cp.m_attributeset_id in  (1000001,1000206) OR
        cp.m_attributeset_id IN (1000006, 1000195,1000198,1000204) OR cp.m_product_id in (1017801,1019491) OR
        cp.m_attributeset_id IN (1000018, 1000031, 1000012, 1000062,1000917,1000918,1000919,1000920)
    )
    UNION ALL

    -- 9: Số lượng giảm do mạ băng (quy NET) - Khối này cần JOIN riêng do logic tính toán chi tiết theo thuộc tính
    SELECT
       
        SUM(
           -1 * CASE
			    WHEN att.m_attributevalue_id IN (1000093, 1000917) THEN 0.1
			    WHEN att.m_attributevalue_id IN (1000224, 1000918) THEN 0.02
			    WHEN att.m_attributevalue_id IN (1000095, 1000919) THEN 0.03
			    WHEN att.m_attributevalue_id IN (1000090, 1000920) THEN 0.05
			    ELSE 0
            END * bp.productionqty
        ) AS sl,
        SUM(
             -1 * CASE
			    WHEN att.m_attributevalue_id IN (1000093, 1000917) THEN 0.1
			    WHEN att.m_attributevalue_id IN (1000224, 1000918) THEN 0.02
			    WHEN att.m_attributevalue_id IN (1000095, 1000919) THEN 0.03
			    WHEN att.m_attributevalue_id IN (1000090, 1000920) THEN 0.05
			    ELSE 0
            END * bp.productionqty * bp.hsv_dinhmuc
        ) AS tt
    FROM _3_base_production bp
    JOIN m_attributeinstance att ON att.m_attributesetinstance_id = bp.m_attributesetinstance_id
    WHERE att.m_attributevalue_id IN (1000093, 1000224, 1000095, 1000090,1000917,1000918,1000919,1000920)
    

) AS k
left join _3_1_sl_sx sl_sx on true
group by sl_sx.sl,sl_sx.tt]]>
	</queryString>
	<field name="stt" class="java.lang.Integer">
		<property name="com.jaspersoft.studio.field.name" value="stt"/>
		<property name="com.jaspersoft.studio.field.label" value="stt"/>
	</field>
	<field name="noidung" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="noidung"/>
		<property name="com.jaspersoft.studio.field.label" value="noidung"/>
	</field>
	<field name="sl" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="sl"/>
		<property name="com.jaspersoft.studio.field.label" value="sl"/>
	</field>
	<field name="tt" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="tt"/>
		<property name="com.jaspersoft.studio.field.label" value="tt"/>
	</field>
	<field name="tt_dm" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="tt_dm"/>
		<property name="com.jaspersoft.studio.field.label" value="tt_dm"/>
	</field>
	<field name="cl" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="cl"/>
		<property name="com.jaspersoft.studio.field.label" value="cl"/>
	</field>
	<field name="hq" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="hq"/>
		<property name="com.jaspersoft.studio.field.label" value="hq"/>
	</field>
	<variable name="tong_hq" class="java.lang.Double" calculation="Sum">
		<variableExpression><![CDATA[$F{hq}]]></variableExpression>
	</variable>
	<group name="Group1">
		<groupFooter>
			<band height="26">
				<textField pattern="#,##0" isBlankWhenNull="true">
					<reportElement x="690" y="0" width="110" height="26" uuid="a6719cc0-dbf0-4b54-8521-dae00e85ac6b">
						<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="7c80f3a6-688f-4285-9619-34dd6baf7c50"/>
						<property name="com.jaspersoft.studio.unit.width" value="px"/>
						<property name="com.jaspersoft.studio.unit.height" value="px"/>
					</reportElement>
					<box leftPadding="2" rightPadding="2">
						<pen lineWidth="0.5"/>
					</box>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font fontName="Arial" size="11" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$V{tong_hq}]]></textFieldExpression>
				</textField>
				<textField pattern="#,##0" isBlankWhenNull="true">
					<reportElement x="0" y="0" width="690" height="26" uuid="ef688be1-c77b-4651-b391-4e30b51b3be8">
						<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="0e7d2c41-4fc0-4778-94b5-fc4f5d733b53"/>
						<property name="com.jaspersoft.studio.unit.width" value="px"/>
						<property name="com.jaspersoft.studio.unit.height" value="px"/>
					</reportElement>
					<box>
						<pen lineWidth="0.5"/>
					</box>
					<textElement textAlignment="Left" verticalAlignment="Middle">
						<font fontName="Arial" size="11" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA["Tổng cộng"]]></textFieldExpression>
				</textField>
			</band>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="83" splitType="Stretch">
			<textField isBlankWhenNull="true">
				<reportElement x="0" y="41" width="800" height="20" uuid="fa9505a0-822f-4b00-98f5-2226cb21359a">
					<property name="local_mesure_unitheight" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<textElement textAlignment="Center">
					<font fontName="Arial" size="16" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA["BÁO CÁO HIỆU QUẢ KINH DOANH"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="0" y="63" width="800" height="20" uuid="833f4f8b-30da-4d96-968f-50b7cb9a423c">
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<textElement textAlignment="Center">
					<font fontName="Arial" size="12" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA["Kỳ báo cáo : " + new SimpleDateFormat("dd/MM/yyyy").format($P{StartDate}) + " To "  + new SimpleDateFormat("dd/MM/yyyy").format($P{EndDate})]]></textFieldExpression>
			</textField>
			<subreport>
				<reportElement x="0" y="0" width="800" height="40" uuid="39b3fb27-1ede-4798-a538-d5a701127860"/>
				<subreportParameter name="AD_CLIENT_ID">
					<subreportParameterExpression><![CDATA[$P{AD_CLIENT_ID}]]></subreportParameterExpression>
				</subreportParameter>
				<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
				<subreportExpression><![CDATA[$P{SUBREPORT_DIR}+"CompanyHeader.jasper"]]></subreportExpression>
			</subreport>
		</band>
	</title>
	<columnHeader>
		<band height="30" splitType="Stretch">
			<staticText>
				<reportElement x="0" y="0" width="30" height="30" uuid="7f792bb5-3f6a-4c3c-9da8-0bcd3a66f652">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="2073fe02-5f17-43fa-85a9-edda79ae77a0"/>
				</reportElement>
				<box>
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[STT]]></text>
			</staticText>
			<staticText>
				<reportElement x="30" y="0" width="200" height="30" uuid="b74a215e-eaea-4a38-b42b-e66cc8e33e7e">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="89e03a28-680a-44d2-821a-a03104820af1"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box>
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Nội dung]]></text>
			</staticText>
			<staticText>
				<reportElement x="230" y="0" width="100" height="30" uuid="421a1e58-3d06-490d-9311-d2f3881abe90">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="dab28f20-7a1c-458c-add7-a3e2a147f519"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box>
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Số lượng]]></text>
			</staticText>
			<staticText>
				<reportElement x="330" y="0" width="120" height="30" uuid="037855a7-c8f4-44ac-8152-fd112721312a">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="3f749469-0f08-431c-8eb4-0a193d41a22a"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box>
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Thành tiền]]></text>
			</staticText>
			<staticText>
				<reportElement x="450" y="0" width="120" height="30" uuid="15d0b445-c288-4a21-b5db-5155c70270b1">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="9524127a-70d8-48c2-a535-436e53b7dcf2"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box>
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Thành tiền ĐM]]></text>
			</staticText>
			<staticText>
				<reportElement x="570" y="0" width="120" height="30" uuid="50d59f78-20e0-4512-adcf-8aa218ffc948">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="0e7d2c41-4fc0-4778-94b5-fc4f5d733b53"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box>
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Chênh lệch]]></text>
			</staticText>
			<staticText>
				<reportElement x="690" y="0" width="110" height="30" uuid="1060a95d-6adb-493e-a39f-33c9b425fcd6">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="7c80f3a6-688f-4285-9619-34dd6baf7c50"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
				</reportElement>
				<box>
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="11" isBold="true"/>
				</textElement>
				<text><![CDATA[Hiệu quả]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="26" splitType="Stretch">
			<textField isBlankWhenNull="false">
				<reportElement x="0" y="0" width="30" height="26" uuid="8ce784ff-1f78-47b3-b1a3-5bc5e9a96d7b">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="2073fe02-5f17-43fa-85a9-edda79ae77a0"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<box>
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{stt}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="30" y="0" width="200" height="26" uuid="c08d7d87-2fbf-443b-a2a5-2013ef08d0f5">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="89e03a28-680a-44d2-821a-a03104820af1"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2">
					<pen lineWidth="0.5"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font fontName="Arial" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{noidung}]]></textFieldExpression>
				<hyperlinkParameter name="AD_CLIENT_ID">
					<hyperlinkParameterExpression><![CDATA[$P{AD_CLIENT_ID}]]></hyperlinkParameterExpression>
				</hyperlinkParameter>
				<hyperlinkParameter name="StartDate">
					<hyperlinkParameterExpression><![CDATA[$P{StartDate}]]></hyperlinkParameterExpression>
				</hyperlinkParameter>
				<hyperlinkParameter name="EndDate">
					<hyperlinkParameterExpression><![CDATA[$P{EndDate}]]></hyperlinkParameterExpression>
				</hyperlinkParameter>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="true">
				<reportElement x="230" y="0" width="100" height="26" uuid="db7a47f4-f323-47ea-ab19-e96fb9cc1b62">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="dab28f20-7a1c-458c-add7-a3e2a147f519"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2">
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font fontName="Arial" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{sl}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="true">
				<reportElement x="330" y="0" width="120" height="26" uuid="3e0aba92-06f5-4310-afba-10bc728ee600">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="3f749469-0f08-431c-8eb4-0a193d41a22a"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2">
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font fontName="Arial" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{tt}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="true">
				<reportElement x="450" y="0" width="120" height="26" uuid="3410cb4d-bab1-493d-b7e9-79f9d90529b3">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="9524127a-70d8-48c2-a535-436e53b7dcf2"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2">
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font fontName="Arial" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{tt_dm}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="true">
				<reportElement x="570" y="0" width="120" height="26" uuid="a4467dba-b8bf-4a1b-b301-600a060bce2e">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="0e7d2c41-4fc0-4778-94b5-fc4f5d733b53"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2">
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font fontName="Arial" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{cl}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="true">
				<reportElement x="690" y="0" width="110" height="26" uuid="5968435b-6a31-4334-b048-dfd28869bad9">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="7c80f3a6-688f-4285-9619-34dd6baf7c50"/>
					<property name="com.jaspersoft.studio.unit.width" value="px"/>
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2">
					<pen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font fontName="Arial" size="11"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{hq}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<summary>
		<band height="40" splitType="Stretch">
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField-4" x="570" y="0" width="230" height="19" forecolor="#000000" backcolor="#FFFFFF" uuid="61516d35-ea2a-449f-a3f9-d1aabd1e024b"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA["Ngày in: " + new SimpleDateFormat("dd/MM/yyyy hh24:mm").format(new Date())]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement key="staticText-8" positionType="Float" stretchType="RelativeToTallestObject" x="570" y="20" width="230" height="20" uuid="9f32782f-e8a5-4cd9-9632-f8b988fedd05">
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
					<property name="com.jaspersoft.studio.unit.y" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2">
					<pen lineWidth="0.25"/>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="12" isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[Kiểm soát]]></text>
			</staticText>
			<staticText>
				<reportElement key="staticText-8" positionType="Float" stretchType="RelativeToTallestObject" x="0" y="20" width="230" height="20" uuid="87dac090-94bc-44f3-ad95-b4774e52384d">
					<property name="com.jaspersoft.studio.unit.height" value="px"/>
					<property name="com.jaspersoft.studio.unit.y" value="px"/>
				</reportElement>
				<box leftPadding="2" rightPadding="2">
					<pen lineWidth="0.25"/>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Arial" size="12" isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[Lập biểu]]></text>
			</staticText>
		</band>
	</summary>
</jasperReport>
